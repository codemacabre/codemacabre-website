---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseLayout from '~/layouts/BaseLayout.astro';
import selfImg from '~/assets/images/self.png';
import selfData from '~/assets/data/self.json';
import booksData from '~/assets/data/books.json';

interface Project {
  slug: string;
  data: {
    current: boolean;
    date: Date;
    title: string;
  };
}

const pageTitle = 'About';
const allNotes = await getCollection('notes');
const allProjects = await getCollection('projects');

let notesWritten = 0;
let booksRead = 0;
let currentProjects: Project[] = [];

allNotes.forEach((note) => {
  if (note.data.date.getFullYear() === new Date().getFullYear()) {
    notesWritten++;
  }
});

booksData.forEach((book) => {
  if (Number(book.year) === new Date().getFullYear()) {
    booksRead++;
  }
});

allProjects.forEach((project) => {
  if (project.data.current) {
    currentProjects.push(project);
  }
});

currentProjects.sort((a, b) => {
  return a.data.title.localeCompare(b.data.title);
});
---
<BaseLayout pageTitle={pageTitle}>
  <h1>{pageTitle}</h1>
  <p>Welcome to Code Macabre!</p>
  <p>
    This is the personal site of me, Myles Lewando (he&#8288;/&#8288;him), a developer and designer, specialising in data visualisation and accessibility.
  </p>
  <p>I began freelancing as a web developer in 2016, then formally changed career to become a full-time developer in 2019. My background is in education, data visualisation, and design.</p>
  <p>Inclusive, ethical technology and data justice are integral to my work and my values.</p>
  <Image
    class="small center circle"
    src={selfImg}
    alt="A black and white grainy photo of my head and shoulders. I have a long pointy beard and a mohawk, with a black censored bar across my eyes"
  />
  <h2 id="now">Now</h2>
  <p>
    I've been working as a {selfData.organisation.position} at <a href={selfData.organisation.url}>{selfData.organisation.name}</a> since {selfData.organisation.startDate}. {currentProjects.length > 0 && (
      <>Outside of work, I'm currently spending time on my personal project{currentProjects.length === 1 ? '' : 's'},
        {
          currentProjects.length === 1 ? (
            <> <a href={`/projects/${currentProjects[0].slug}`}>{currentProjects[0].data.title}</a>.</>
          ) : currentProjects.length === 2 ? (
            <>
              <a href={`/projects/${currentProjects[0].slug}`}>{currentProjects[0].data.title}</a> and 
              <a href={`/projects/${currentProjects[1].slug}`}>{currentProjects[1].data.title}</a>.
            </>
          ) : (
            <>
              {currentProjects.map((project, index) => (
                <>
                  <a href={`/projects/${project.slug}`}>{project.data.title}</a>{index < currentProjects.length - 2 ? ', ' : index === currentProjects.length - 2 ? ', and ' : ''}
                </>
              ))}.</>
          )
        }
      </>
    )}
  </p>
  <p>So far this year, I've <a href="/notes">written {notesWritten} {notesWritten === 1 ? 'note' : 'notes'}</a> and <a href="/reading">read {booksRead} {booksRead === 1 ? 'book' : 'books'}</a>.</p>
  <h2 id="fun-facts">Fun facts</h2>
  <p>My household includes a menagerie of multi-legged pets of various species, including:</p>
  <ul class="indented">
    {selfData.pets.map((pet) => <li>{pet.count}&times; {pet.species_en} <em>({pet.species_la})</em></li>)}
  </ul>
  <p>...and one human child.</p>
  <p>
    As morbid as it sounds, I love <a href="/notes/on-graveyards">cemeteries</a>, crypts, and catacombs. Whenever possible, I try to visit weird and unusual ones, or just take a quiet walk around a local one.
  </p>
  <h2 id="contact">Contact</h2>
  <p>Get in touch via <span class="mail">email</span><noscript> at contact (at) codemacabre (dot) com</noscript>, or reach out on <a href="https://social.coop/@codemacabre">Mastodon</a> or <a href="https://www.linkedin.com/in/codemacabre/">LinkedIn</a>.</p>
  <h2 class="sr-only">Disclaimer</h2>
  <p class="callout">The views and opinions on this site are my own, and do not necessarily reflect those of my employer.</p>
</BaseLayout>
